<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>home</title>
    <style>
        textarea {
            border: 0;
            outline: none;
            padding: 0;
            margin: 0;
            /** to order all the textarea vertically */
            display: list-item;
            /** allows to set min height of textarea as 1 row, not as 2 rows as its default value */
            !important;height: 0;
            /** remove resize handle (a little triangle in the bottom right of textarea) */
            resize: none;
        }
    </style>
    <link rel="stylesheet" type="text/css" href="bootstrap3.3.7/css/bootstrap.css"/>
    <link rel="icon" type="image/png" href="favicon.ico"/>
    <!--href="../static/favicon.ico"-->
    <script src="jquery-3.3.1.js"></script>
</head>
<body>
<div>
    Hi, Jezh!
</div>

<button id="helper1">helper1</button>
<div><button id="helper2">get_textpart32_value</button></div>
<p id="hel1txt"></p>
<p id="hel2txt"></p>

<div id="text"></div>


<script>
    /** this array allows to note if any text is already called */
    let dataAccessCounter = [];

    $(function () {
        $('#helper1').click(function (e) {
            // .html( function ), where Function( Integer index, htmlString oldhtml ) => htmlString... Within the
            // function, "this" refers to the current element in the set. (in this case, that is object HTMLButtonElement)
            $('#hel1txt').html('<h1>ui<div style="display:none;">ou</div>hou</h1>');
            $('#hel1txt').html((index, oldhtml) => {return oldhtml + '<p>' + $('#ta26').html() + '</p>'});
            $('#hel1txt').html((index, oldhtml) => {return oldhtml + '<p id="rrr">tot\r\r\rou</p>'});
            $('#hel1txt').html((index, oldhtml) => {return oldhtml + $('p#hel1txt p#rrr').html()});
            $('#ta26').append($('p#hel1txt p#rrr').html());
            let soMany = 10;
            console.log(`This is ${soMany} times easier!   tot\r\r\rou`);
        });

// ================================================================================ MAIN BUSINESS LOGIC

// --------------------------------------------------------------------------------------------------------------------
// ------------------------------------------------------- GET and RENDER all the TEXT PART with given textCommonDataId
// --------------------------------------------------------------------------------------------------------------------

/** get all the textparts from db in proper order, create textarea for each one and fill the textarea with its content */
        function extractTextPartsToHtml(textCommonDataId) {
            /** id for the form that will be created by createTextCommonDataElement() method  */
            let textFormId = 'txt' + textCommonDataId;

            /** when first call of given function with such textCommonDataId, create form element */
            createTextCommonDataElement(textFormId);

            /** get data (i.e. sorted array of textpart objects), create textarea for each object and render its content.
             * To avoid data duplication, check the flag in dataAccessCounter */
            if (!dataAccessCounter.includes(textCommonDataId)) {
                $.ajax({
                    type:'GET',
                    /** get all the textparts */ // FIXME: make to get a textpart bunch with limited size
                    url:'text-common-data/'+ textCommonDataId + '/text-parts',
                    success: function (data, textStatus, jqXHR) {
                        // check the array filling
                        data.forEach(data => console.log('id: ' + data.id + ', ' +
                            'nextItem: ' + data.nextItem + '/ '));

                        /** create the textarea elements and fill them with the textparts content */
                        data.forEach(data => {
                            let thisTextareaId = 'ta' + data.id;

                            /** create current textarea element */
                            createTextareaElement(textFormId, thisTextareaId);

                            /** fill it with content and auto grow its height according loaded content */
                                fillTextareaWithContent(thisTextareaId, data);
                        });

// todo: установить на .change, чтобы когда textarea опустела, она становилась hidden (и при закрытии уничтожалась), чтобы
// при выделении или движении стрелки (в т.ч. Ctrl + RIGHT) или выделении стрелкой (SHIFT + RIGHT, Ctrl + SHIFT + RIGHT)
// происходило перескакивание на соседнюю область - а это как сделать?
                        // check
                        console.log('extractTextPartsToHtml(' + textCommonDataId + ') textStatus: ' + textStatus);

                        /** set the flag "dataAccessCounter.includes(textCommonDataId)" to true */
                        dataAccessCounter.push(textCommonDataId);
                    },
                    // todo: to write appropriate methods
                    error: function (jqXHR, textStatus, errorThrown) {
                        console.log('some error');
                    }
                });
            }
        }

// ===================================================================================== AUXILIARY FUNCTIONS

        /** when first call of given function with such textCommonDataId, create form element */
        function createTextCommonDataElement(textFormId) {
            // condition check to avoid duplication
            if ($('#' + textFormId).html() === undefined) {
                $('#text').append(function (index, html) {
                    return $('<form id="' + textFormId + '" style="margin-left: 60px">' +
                        '<input type="submit" value="close"></form>')
                });
            }
        }
// ----------------------------------------------------------------------------------------------------------------

        /** create and append textarea child element to existing form element: */
        function createTextareaElement(formId, textareaId) {
            // condition check to avoid duplication
            if ($('#' + textareaId).html() === undefined) {
                $('#' + formId).append(
                    //todo: set convenient textarea width by cols number setting
                    '        <textarea wrap="soft" cols="100" id="' + textareaId + '"' +
                    /** HTML oninput Event Attribute here allows to set the height of this textarea dynamically
                     * in accordance with the number of entered lines, when an element gets user input.
                     * Scroll bar won't be appeared */
                    // "this" references current element, i.e. this textarea, "px" means "pixels"
                    ' oninput=\'this.style.height = ""; this.style.height = this.scrollHeight + "px"\'></textarea>'
                );
            }
        }
// ---------------------------------------------------------------------------------------------------------------

        /** fill textarea element with content and auto grow its height according loaded content */
        function fillTextareaWithContent(thisTextareaId, data) {
            let thisTextArea = $('#' + thisTextareaId);
            thisTextArea.html('id: ' + data.id + ', ' +
                'nextItem: ' + data.nextItem + ', body: '+ data.body + '/ ');
            /** to auto grow the created textarea height according loaded content */
            thisTextArea.height(thisTextArea[0].scrollHeight);
        }
// ---------------------------------------------------------------------------------------------------------------

        /** first version of array sorting */
        function sortArray(array, textCommonDataId) {
            let sortedArray = [];
            let nextId/* = id*/;
            /** specify first item in the textPart sorted list (such one where previousItem = textCommonDataId) */
            for (let i = 0; i < array.length; i++ ) {
                if (array[i].previousItem === textCommonDataId) {
                    nextId = array[i].id;
                    break;
                }
            }
            while (array.length !== 0) {
                for (let i = 0; i < array.length; i++) {
                    if (array[i].id === nextId) {
                /** push item into the end of sorted array */
                        sortedArray.push(array[i]);
                        nextId = array[i].nextItem;
                /** remove the element from the original array, break the for () loop, and then
                 * start the next iteration of the while () loop with a truncated original array*/
                        array.splice(i, 1);
                        break;
                    }
                }
            }
            return sortedArray;
        }

// =========================================================================================== PERFORMING

        $('#helper2').click(function (e) {
            e.preventDefault();
                extractTextPartsToHtml(36);
        });

        $('#txt32').submit(function (e) {
            e.preventDefault();
        })
    });
</script>
</body>
</html>